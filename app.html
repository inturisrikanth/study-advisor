<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Study Advisor ‚Äî Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, Arial, sans-serif; max-width: 1000px; margin: 24px auto; padding: 0 16px; }
      header { display:flex; justify-content:space-between; align-items:center; margin:12px 0; padding:8px 0; border-bottom:1px solid #eee; }
      .muted { color:#666; font-size: 13px; }
      .row { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin: 12px 0; }
      .row label { font-size: 12px; color:#444; display:block; margin-bottom:4px; }
      input, select, button { padding: 8px; font-size: 14px; }
      button { cursor: pointer; }
      .card { border:1px solid #ddd; border-radius: 10px; padding: 12px; margin: 10px 0; }
      .badge { display:inline-block; padding:2px 8px; border-radius: 999px; border:1px solid #ccc; font-size:12px; margin-right:6px; }
      a { color:#0a58ca; text-decoration:none; }
      a:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header>
      <div><strong>Study Advisor</strong> ‚Äî Dashboard</div>
      <div>
        <span id="whoami" class="muted" style="margin-right:12px;"></span>
        <button id="logoutBtn">Log out</button>
      </div>
    </header>

    <!-- Finder Controls -->
    <section>
      <div class="row">
        <div>
          <label>GRE score (optional)</label>
          <input id="gre" type="number" placeholder="e.g. 305" />
        </div>
        <div>
          <label>TOEFL score (optional)</label>
          <input id="toefl" type="number" placeholder="e.g. 90" />
        </div>
        <div>
          <label>Track</label>
          <select id="track">
            <option value="">Any</option>
            <option>CS</option>
            <option>Data</option>
            <option>AI</option>
            <option>Cyber</option>
            <option>IT</option>
            <option>IS</option>
            <option>SE</option>
            <option>Networks</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="searchBtn">Search</button>
        </div>
      </div>

      <div class="row" style="grid-template-columns: repeat(2, minmax(0,1fr));">
        <div>
          <label>
            <input id="onlyGreOptional" type="checkbox" />
            Show programs where GRE is optional/waived
          </label>
        </div>
        <div>
          <label>
            <input id="onlyStem" type="checkbox" />
            STEM only (OPT 36 months)
          </label>
        </div>
      </div>

      <div id="status" class="muted">Ready.</div>
      <div id="results"></div>
    </section>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // ‚¨áÔ∏è Replace these with your real values
      const SUPABASE_URL = "https://xxpwjsgwrdagcbbttukh.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_oGIsd2pVpYcdJXics1PltQ_nFlsks_c";
      const LANDING_URL = "https://inturisrikanth.github.io/study-advisor/"; // trailing slash

      // Single Supabase client
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // ---------- Auth gate + profile bootstrap ----------
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        location.href = LANDING_URL; // not signed in ‚Üí go to landing
        throw new Error("Not signed in");
      }

      // 1) Ensure a profile row exists
      await supabase
        .from("profiles")
        .upsert({ user_id: user.id, email: user.email }, { onConflict: "user_id" });

      // 2) Load profile
      let { data: profile } = await supabase
        .from("profiles")
        .select("username, is_admin, first_name, last_name")
        .eq("user_id", user.id)
        .maybeSingle();

      // 3) üîπ Tiny tweak: copy names from auth metadata (from sign-up) if missing
      const metaFirst = user.user_metadata?.first_name || null;
      const metaLast  = user.user_metadata?.last_name || null;
      if ((!profile?.first_name || !profile?.last_name) && (metaFirst || metaLast)) {
        await supabase
          .from("profiles")
          .update({ first_name: metaFirst, last_name: metaLast })
          .eq("user_id", user.id);
        ({ data: profile } = await supabase
          .from("profiles")
          .select("username, is_admin, first_name, last_name")
          .eq("user_id", user.id)
          .maybeSingle());
      }

      // 4) First-time username prompt (optional public handle)
      if (!profile || !profile.username) {
        let saved = false;
        while (!saved) {
          const u = prompt("Choose a username (letters/numbers/._-):");
          if (!u) break; // user canceled
          const { error } = await supabase
            .from("profiles")
            .update({ username: u })
            .eq("user_id", user.id);
          if (!error) {
            profile = { ...(profile || {}), username: u };
            saved = true;
          } else {
            alert(error.message); // e.g., duplicate username
          }
        }
      }

      // 5) Show identity in header (Full Name preferred, else @username, else email)
      const headerName =
        (profile?.first_name || profile?.last_name)
          ? `${profile.first_name ?? ""} ${profile.last_name ?? ""}`.trim()
          : (profile?.username ? `@${profile.username}` : (user.email || "Signed in"));

      document.getElementById("whoami").innerHTML = headerName +
        (profile?.is_admin ? ' ¬∑ <span style="border:1px solid #bbb;border-radius:999px;padding:2px 8px;font-size:12px;">Admin</span>' : '');

      // 6) Logout
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await supabase.auth.signOut();
        location.href = LANDING_URL;
      });

      // ---------- Finder logic ----------
      const el = (id) => document.getElementById(id);

      function buildFilters() {
        const gre = Number(el("gre").value || 0);
        const toefl = Number(el("toefl").value || 0);
        const track = el("track").value;
        const onlyGreOptional = el("onlyGreOptional").checked;
        const onlyStem = el("onlyStem").checked;
        return { gre, toefl, track, onlyGreOptional, onlyStem };
      }

      async function search() {
        el("status").textContent = "Searching‚Ä¶";
        el("results").innerHTML = "";

        const f = buildFilters();

        // Base query from the joined view
        let query = supabase
          .from("programs_view")
          .select("program_id, university_name, name, track, gre_required, gre_min_total, english_tests_accepted, toefl_min_total, tuition_usd_per_year, program_url, website_url, stem, opt_months")
          .order("university_name", { ascending: true });

        // Server-side filters where possible
        if (f.track) query = query.eq("track", f.track);
        if (f.onlyStem) query = query.eq("stem", "Y");

        const { data, error } = await query;

        if (error) {
          el("status").textContent = "Error: " + error.message;
          return;
        }

        // Client-side filters (scores + GRE optional logic)
        const filtered = data.filter(row => {
          // GRE logic
          if (f.onlyGreOptional && !(row.gre_required === "optional" || row.gre_required === "waived")) return false;
          if (f.gre && row.gre_required === "required") {
            if (row.gre_min_total && f.gre < row.gre_min_total) return false;
          }
          // TOEFL logic
          if (f.toefl) {
            if (row.toefl_min_total && f.toefl < row.toefl_min_total) return false;
          }
          return true;
        });

        el("status").textContent = `Found ${filtered.length} program(s).`;
        renderResults(filtered);
      }

      function renderResults(rows) {
        const container = el("results");
        for (const p of rows) {
          const div = document.createElement("div");
          div.className = "card";
          const greInfo = `${p.gre_required || "n/a"}${p.gre_min_total ? ` (min ${p.gre_min_total})` : ""}`;
          const engInfo = `${p.english_tests_accepted || "n/a"}${p.toefl_min_total ? ` (TOEFL ‚â• ${p.toefl_min_total})` : ""}`;
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong>${p.name}</strong> ‚Äî ${p.university_name}
                <div class="muted" style="margin-top:2px;">
                  ${p.program_url ? `<a href="${p.program_url}" target="_blank" rel="noopener">Program page</a>` : ""}
                  ${p.website_url ? ` ‚Ä¢ <a href="${p.website_url}" target="_blank" rel="noopener">University</a>` : ""}
                </div>
              </div>
              <div>
                <span class="badge">${p.track}</span>
                <span class="badge">${p.stem === "Y" ? `STEM (OPT ${p.opt_months || 36}m)` : "Non-STEM"}</span>
              </div>
            </div>
            <div class="muted" style="margin-top:6px;">
              GRE: ${greInfo} ‚Ä¢ English: ${engInfo}
              ${p.tuition_usd_per_year ? ` ‚Ä¢ Tuition ~$${p.tuition_usd_per_year}/yr` : ""}
            </div>
          `;
          container.appendChild(div);
        }
      }

      // Wire up search
      document.getElementById("searchBtn").addEventListener("click", search);
      // Run once on load
      search();
    </script>
  </body>
</html>