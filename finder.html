<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Study Advisor – Finder</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
      .row { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 12px; margin-bottom: 12px; }
      .row label { font-size: 12px; color: #444; display:block; margin-bottom: 4px; }
      input, select, button { padding: 8px; font-size: 14px; }
      button { cursor: pointer; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 10px 0; }
      .muted { color: #666; font-size: 12px; }
      .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ccc; font-size: 12px; margin-right: 6px;}
    </style>
  </head>
  <body>
    <h1>Study Advisor – Program Finder (MVP)</h1>

    <div class="row">
      <div>
        <label>GRE score (optional)</label>
        <input id="gre" type="number" placeholder="e.g. 305" />
      </div>
      <div>
        <label>TOEFL score (optional)</label>
        <input id="toefl" type="number" placeholder="e.g. 90" />
      </div>
      <div>
        <label>Track</label>
        <select id="track">
          <option value="">Any</option>
          <option>CS</option>
          <option>Data</option>
          <option>AI</option>
          <option>Cyber</option>
          <option>IT</option>
          <option>IS</option>
          <option>SE</option>
          <option>Networks</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="searchBtn">Search</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>
          <input id="onlyGreOptional" type="checkbox" />
          Show programs where GRE is optional/waived
        </label>
      </div>
    </div>

    <div id="status" class="muted">Ready.</div>
    <div id="results"></div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // ⬇️ REPLACE with your values
      const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // placeholder for public repo
      const SUPABASE_ANON_KEY = "sb_publishable_oGIsd2pVpYcdJXics1PltQ_nFlsks_c";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const el = (id) => document.getElementById(id);

      function buildFilters() {
        const gre = Number(el("gre").value || 0);
        const toefl = Number(el("toefl").value || 0);
        const track = el("track").value;
        const onlyGreOptional = el("onlyGreOptional").checked;
        return { gre, toefl, track, onlyGreOptional };
      }

      async function search() {
        el("status").textContent = "Searching…";
        el("results").innerHTML = "";

        const f = buildFilters();

        // Base query from the joined view
        let query = supabase
          .from("programs_view")
          .select("program_id, university_name, name, track, gre_required, gre_min_total, english_tests_accepted, toefl_min_total, tuition_usd_per_year, program_url, website_url, stem, opt_months")
          .order("university_name", { ascending: true });

        // Track filter (server-side)
        if (f.track) query = query.eq("track", f.track);

        // Fetch from DB
        const { data, error } = await query;
        if (error) {
          el("status").textContent = "Error: " + error.message;
          return;
        }

        // Client-side filters for scores/gre-optional logic
        const filtered = data.filter(row => {
          // GRE logic
          if (f.onlyGreOptional && !(row.gre_required === "optional" || row.gre_required === "waived")) {
            return false;
          }
          if (f.gre && row.gre_required === "required") {
            if (row.gre_min_total && f.gre < row.gre_min_total) return false;
          }

          // TOEFL logic
          if (f.toefl) {
            // accept if the program either doesn't set a min OR user meets/exceeds it
            if (row.toefl_min_total && f.toefl < row.toefl_min_total) return false;
          }

          return true;
        });

        el("status").textContent = `Found ${filtered.length} program(s).`;

        // Render
        for (const p of filtered) {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <strong>${p.name}</strong> — ${p.university_name}
                <div class="muted">${p.program_url ? `<a href="${p.program_url}" target="_blank">Program page</a>` : ""} ${p.website_url ? ` • <a href="${p.website_url}" target="_blank">University</a>` : ""}</div>
              </div>
              <div>
                <span class="badge">${p.track}</span>
                <span class="badge">${p.stem === "Y" ? "STEM (OPT " + (p.opt_months || 36) + "m)" : "Non-STEM"}</span>
              </div>
            </div>
            <div class="muted" style="margin-top:8px;">
              GRE: ${p.gre_required || "n/a"} ${p.gre_min_total ? `(min ${p.gre_min_total})` : ""} •
              English: ${p.english_tests_accepted || "n/a"} ${p.toefl_min_total ? `(TOEFL ≥ ${p.toefl_min_total})` : ""}
              ${p.tuition_usd_per_year ? ` • Tuition ~$${p.tuition_usd_per_year}/yr` : ""}
            </div>
          `;
          el("results").appendChild(div);
        }
      }

      el("searchBtn").addEventListener("click", search);
      // Run once on load
      search();
    </script>
  </body>
</html>